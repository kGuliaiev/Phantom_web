import React, { useEffect, useState } from 'react';
import './App.css';
import { CryptoManager } from './crypto/CryptoManager';
import { API } from './config';
import { clearAll } from './crypto/CryptoManager';
import ChatWindow from '../components/ChatWindow.jsx';
import ContactList from '../components/ContactList';
import ChatList from '../components/ChatList';
import AuthTabs from '../components/AuthTabs';

function App() {
  const [crypto, setCrypto] = useState(null);
  const [userId, setUserId] = useState('');
  const [loggedIn, setLoggedIn] = useState(false);
  const [selectedChat, setSelectedChat] = useState(null);
  const [chatMessages, setChatMessages] = useState([]);
  const [message, setMessage] = useState('');
  const [tab, setTab] = useState('chats'); // 'contacts' | 'chats'

  useEffect(() => {
    setCrypto(new CryptoManager());
    const saved = localStorage.getItem('phantom_username');
    if (saved) {
      setUserId(saved);
      setLoggedIn(true);
    }
  }, []);

  const handleAuthSuccess = () => {
    const saved = localStorage.getItem('phantom_username');
    if (saved) {
      setUserId(saved);
      setLoggedIn(true);
    }
  };

  const selectChat = async (user) => {
    setSelectedChat(user);
  
    try {
      const res = await fetch(`${API.receiveMessagesURL}?receiverId=${userId}`);
      const messages = await res.json();
      if (!Array.isArray(messages)) throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π');
  
      const relevant = messages.filter(
        (m) =>
          (m.senderId === user.username && m.receiverId === userId) ||
          (m.senderId === userId && m.receiverId === user.username)
      );
  
      const decryptedMessages = await Promise.all(
        relevant.map(async (msg) => {
          try {
            const plain = await crypto.decryptMessage(msg.text);
            return {
              id: msg._id,
              text: `${msg.senderId}: ${plain}`,
              status: msg.status || 'sent'
            };
          } catch {
            return {
              id: msg._id,
              text: `${msg.senderId}: [–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è]`,
              status: msg.status || 'sent'
            };
          }
        })
      );
  
      setChatMessages(decryptedMessages.map((m) => m.text));
  
      // üì® –û—Ç–ø—Ä–∞–≤–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      const unreadIds = relevant
        .filter((m) => m.receiverId === userId && m.status !== 'read')
        .map((m) => m._id);
  
      if (unreadIds.length > 0) {
        await fetch(`${API.confirmReadURL}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messageIds: unreadIds })
        });
      }
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", err);
    }
  };

  const sendMessage = async () => {
    if (!selectedChat) return;
    try {
      const receiverId = selectedChat.username;
      const res = await fetch(`${API.checkUserURL}?userId=${receiverId}`);
      const { publicKey } = await res.json();
      const encrypted = await crypto.encryptMessage(publicKey, message);

      await fetch(`${API.sendMessageURL}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          senderId: userId,
          receiverId,
          text: encrypted
        })
      });

      setMessage('');
      selectChat(selectedChat); // –æ–±–Ω–æ–≤–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
    }
  };

  if (!crypto) return <div>–ó–∞–≥—Ä—É–∑–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...</div>;

  if (!loggedIn) return <AuthTabs onSuccess={handleAuthSuccess} />;

  return (
    <div className="App">
      <header>
        <h2>üë§ {userId}</h2>

  {/* –ö–ù–û–ü–ö–ò –°–ï–°–°–ò–ò */}
  <div className="session-actions">
    <button onClick={handleLogout}>üö™ –í—ã—Ö–æ–¥</button>
    <button onClick={handleFullDelete} className="danger-button">üß® –£–¥–∞–ª–∏—Ç—å –≤—Å—ë!</button>
  </div>
  
        <div className="tabs">
          <button onClick={() => setTab('contacts')} className={tab === 'contacts' ? 'active' : ''}>–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
          <button onClick={() => setTab('chats')} className={tab === 'chats' ? 'active' : ''}>–ß–∞—Ç—ã</button>
        </div>
      </header>

      <main className="main-layout">
        <div className="sidebar">
          {tab === 'contacts' ? (
            <ContactList currentUser={userId} onSelect={selectChat} />
          ) : (
            <ChatList currentUser={userId} onSelect={selectChat} />
          )}
        </div>

        <div className="content">
          {selectedChat ? (
            <ChatWindow
              selectedChat={selectedChat}
              messages={chatMessages}
              message={message}
              onMessageChange={setMessage}
              onSend={sendMessage}
            />
          ) : (
            <div className="no-chat">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç</div>
          )}
        </div>
      </main>
    </div>
  );
}

const handleLogout = () => {
  localStorage.removeItem('phantom_username');
  localStorage.removeItem('token');
  setUserId('');
  setLoggedIn(false);
};

const handleFullDelete = async () => {
  const confirmed = window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è?');
  if (!confirmed) return;

  try {
    await fetch(`${API.fullDeleteUserURL}/${userId}`, {
      method: 'DELETE',
    });
    await clearAll(); // –û—á–∏—Å—Ç–∫–∞ IndexedDB –∏ –∫–ª—é—á–µ–π
    localStorage.removeItem('phantom_username');
    localStorage.removeItem('token');
    setUserId('');
    setLoggedIn(false);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
  }
};



export default App;